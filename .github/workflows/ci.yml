name: CI - Tests complets

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:

  backend:
    name: Backend - Tests Spring
    runs-on: ubuntu-latest

    steps:
      # clone le repo dans la VM
      - uses: actions/checkout@v4

      # mise en place de Java à la bonne version
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21

      # exécute les tests
      - name: Run backend tests
        working-directory: Backend
        run: mvn clean test


  selenium:
    name: Selenium - Tests E2E
    runs-on: ubuntu-latest
    needs: backend

    steps:
      # clone le repo dans la VM
      - uses: actions/checkout@v4

      # mise en place de Java à la bonne version
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21

      # mise en place de NodeJs à la bonne version
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # mise en place de Chrome pour les tests dans le navigateur
      - name: Setup Chrome
        uses: browser-actions/setup-chrome@v1

      # démarre le backend
      - name: Start backend
        working-directory: Backend
        run: |
          mvn spring-boot:run -Dspring-boot.run.arguments=--server.port=8080 > backend.log 2>&1 &
          echo "Backend starting..."
          sleep 20
          cat backend.log || true

      # démarre le front end
      - name: Start frontend
        working-directory: Frontend
        run: |
          npm ci
          npm start > frontend.log 2>&1 &
          echo "Frontend starting..."
          sleep 30
          cat frontend.log || true

      # lance les tests Selenium
      - name: Run Selenium tests
        working-directory: selenium-tests
        run: mvn clean test